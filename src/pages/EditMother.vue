<template>
  <div class="page">
    <img src="../assets/editMother/pic_01.jpg" class="page-bg">
    <img src="../assets/editMother/pic_04.png" class="pic-frame center">
    <div ref="mask" class="img-container center">
      <img ref="motherImg" :src="motherPic" class="motherPic" :style="imgStyle">
    </div>
    <!--<img src="../assets/editMother/pic_01.png" class="tips center">-->
    <img src="../assets/editMother/pic_02.png" class="next center">
    <input class="next center" type="file" ref="self" @change="takeSelf">
    <img src="../assets/editMother/pic_03.png" class="reTake center">
    <input class="reTake center" type="file" ref="mother" @change="takeMother">
    <canvas hidden ref="canvas" width="549" height="764"/>
  </div>
</template>

<script>
  import { parseFile } from '../components/utils'
  import { vuexMixin } from '../components/mixins/index'

  /* for  AlloyFinger  start */
  let afInstance
  import AlloyFinger from '../components/AlloyFinger'
  /* for  AlloyFinger   end  */

  export default {
    name: 'EditMother',
    mixins: [vuexMixin],
    data: () => ({
      deltaX: 0,  // 图片移动横坐标
      deltaY: 0,  // 图片移动纵坐标
    }),
    computed: {
      imgStyle () {
        return {
          top: this.deltaY + 'px',
          left: this.deltaX + 'px',
        }
      }
    },
    methods: {
      takeSelf () {
        const {self, canvas, motherImg} = this.$refs
        const ctx = canvas.getContext('2d')
        const screenRatio = window.innerWidth * 0.695 / 549

        ctx.drawImage(
          motherImg,
          -this.deltaX,
          -this.deltaY,
          549 * screenRatio,
          764 * screenRatio,
          0, 0, 549, 764)

        this.saveMotherPic(canvas.toDataURL())
        parseFile(self.files[0], result => {
          this.moveDown()
          this.saveSelfPic(result)
        })
      },
      takeMother () {
        parseFile(this.$refs.mother.files[0], this.saveMotherPic)
      },
      pressMove (evt) {
        const motherImg = this.$refs.motherImg
        const zoom = window.innerWidth / 790
        this.deltaX += evt.deltaX
        this.deltaY += evt.deltaY

        if (this.deltaX > 0) {
          this.deltaX = 0
        }
        if (this.deltaX < 549 * zoom - motherImg.width) {
          this.deltaX = 549 * zoom - motherImg.width
        }

        if (this.deltaY > 0) {
          this.deltaY = 0
        }
        if (this.deltaY < 764 * zoom - motherImg.height) {
          this.deltaY = 764 * zoom - motherImg.height
        }
      }
      // pressUp (evt) {
      //   alert('test')
      //   this.deltaX += evt.deltaX
      //   this.deltaY += evt.deltaY
      //   if(this.deltaX > 0){
      //     this.deltaX = 0;
      //   }
      //
      //   if(this.deltaX + 549 < 789){
      //     this.deltaX = 789 - 549;
      //   }
      //
      //
      //   if(this.deltaY > 0){
      //     this.deltaY = 0;
      //   }
      //   // if(this.deltaY+764 < 864){
      //   //   this.deltaY = 864 - 764;
      //   // }
      // },
    },
    watch: {
      motherPic () {
        try {
          afInstance.destroy()
        } catch (e) {}
        const el = this.$refs.mask
        // Transform(el)
        // var initScale = 1
        afInstance = new AlloyFinger(el, {
          pressMove: this.pressMove.bind(this),
          // multipointStart: function () {
          //   To.stopAll()
          //   initScale = el.scaleX
          // },
          // pinch: function (evt) {
          //   el.scaleX = el.scaleY = initScale * evt.zoom
          //   // alert(111)
          // },
          // rotate: function (evt) {
          //   el.rotateZ += evt.angle
          // },
          // multipointEnd: function () {
          //   To.stopAll()
          //   if (el.scaleX < 1) {
          //     new To(el, 'scaleX', 1, 500, ease)
          //     new To(el, 'scaleY', 1, 500, ease)
          //   }
          //   if (el.scaleX > 2) {
          //     new To(el, 'scaleX', 2, 500, ease)
          //     new To(el, 'scaleY', 2, 500, ease)
          //   }
          //   var rotation = el.rotateZ % 360
          //   if (rotation < 0) rotation = 360 + rotation
          //   el.rotateZ = rotation
          //   if (rotation > 0 && rotation < 45) { new To(el, 'rotateZ', 0, 500, ease) } else if (rotation >= 315) { new To(el, 'rotateZ', 360, 500, ease) } else if (rotation >= 45 && rotation < 135) { new To(el, 'rotateZ', 90, 500, ease) } else if (rotation >= 135 && rotation < 225) { new To(el, 'rotateZ', 180, 500, ease) } else if (rotation >= 225 && rotation < 315) { new To(el, 'rotateZ', 270, 500, ease) }
          // },
        })
      }
    }
  }
</script>

<style scoped>
  .pic-frame {
    top: 15vw;
    width: 75vw;
  }

  .mask {
    top: 17.5vw;
    width: 69.5vw;
    z-index: 10;
  }

  .img-container {
    top: 17.5vw;
    width: 69.5vw;
    height: 96.7vw;
    overflow: hidden;
  }

  .motherPic {
    position: absolute;
  }

  .tips {
    top: 119vw;
    width: 75vw;
  }

  .next {
    top: 127vw;
    width: 45vw;
  }

  input.next {
    height: 12vw;
    opacity: 0;
  }

  .reTake {
    top: 140vw;
    width: 36vw;
  }

  input.reTake {
    height: 12vw;
    opacity: 0;
  }
</style>
